<!DOCTYPE html><html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>אפליקציית עישון – ממוצעים ומרווחים</title>
  <style>
    :root {
      --bg: #0b1020;        /* כהה אלגנטי */
      --card: #121734;      /* קלף כהה */
      --muted: #9aa3b2;     /* טקסט משני */
      --text: #eaf0ff;      /* טקסט ראשי */
      --accent: #6ea8fe;    /* כפתורים */
      --accent-2: #70e1a1;  /* תשובות חיוביות */
      --danger: #ff7a7a;    /* מחיקה */
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width: 980px; margin: 24px auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.1fr 1fr; } }
    .card { background: var(--card); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.04);} 
    h1 { margin: 0 0 6px; font-size: 22px; }
    .muted { color: var(--muted); font-size: 13px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 0 0 auto; }
    .grow { flex:1 1 auto; }
    label { font-size: 14px; color: var(--muted); }
    input[type="number"] { background: #0e1430; border:1px solid rgba(255,255,255,.08); color:var(--text); border-radius: 12px; padding: 10px 12px; width: 120px; }
    button { cursor: pointer; border: none; border-radius: 12px; padding: 10px 14px; font-weight: 600; font-size: 14px; }
    .btn { background: var(--accent); color:#05122b; }
  .btn2 {
  background: #000;   /* שחור */
  color: #fff;        /* טקסט לבן */
}
    .btn:active { transform: translateY(1px); }
    .btn-ghost { background: transparent; border:1px solid rgba(255,255,255,.12); color:var(--text);} 
    .btn-danger { background: var(--danger); color:#1a0b0b; }
  .ghost2 {
    background: white; color: black;
  }
    .kpi { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px; }
    @media (min-width: 700px){ .kpi { grid-template-columns: repeat(3,minmax(0,1fr)); } }
    .kpi .box { background:#0e1430; padding:14px; border-radius: 14px; border:1px solid rgba(255,255,255,.06); }
    .kpi .ttl { font-size:12px; color:var(--muted); margin-bottom:6px; }
    .kpi .val { font-size:20px; font-variant-numeric: tabular-nums; }
    .ok { color: var(--accent-2); }
    .warn { color: #ffd277; }
    .bad { color: var(--danger); }
    .ta { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; color:var(--muted);}
    .footer { margin-top:6px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .toast { font-size: 13px; color: var(--muted); }
  button.active {
  outline: 2px solid var(--accent-2);
  background: var(--accent-2);
  color: #000;
}
  </style>
</head>
<body>
  <button 
  onclick="window.location.href='index2.html'" 
  style="
    display:block;
    margin:40px auto; 
    padding:12px 24px; 
    font-size:18px; 
    border:none; 
    border-radius:10px; 
    background:#3b82f6; 
    color:#fff; 
    cursor:pointer;
  "
>
  מעבר לעמוד הבא
</button>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h1>אפליקציית עישון</h1>
        <div class="muted">התצוגה מתעדכנת אוטומטית כל 20 שניות (וגם מיד כשיש שינוי).</div><div style="height:10px"></div>
       
        
    <div class="row">
      <label for="targetMinutes">מרווח יעד (דקות) בין סיגריות:</label>
      <input id="targetMinutes" type="number" min="1" step="1" value="120" />
      <button id="btnSmoke" class="btn">עישנתי</button>
      <button id="btnSave" class="btn-ghost ghost2">שמור נתונים</button>
      <button id="btnReset" class="btn-danger">איפוס נתונים</button>
      <button id="btnPause" class="btn-ghost">עצור טיימר</button>
<button id="btnResume" class="btn2">המשך טיימר</button>
    </div>

    <div style="height:14px"></div>

    <div class="kpi">
      <div class="box">
        <div class="ttl">מספר סיגריות כולל</div>
        <div class="val" id="totalCount">0</div>
      </div>
      <div class="box">
        <div class="ttl">מספר סיגריות היום (מאפס ב‑00:00)</div>
        <div class="val" id="todayCount">0</div>
      </div>
      <!-- הוסף איפה שנוח לך בתוך .kpi -->
<div class="box">
  <div class="ttl">זמן מאז התחלת הגמילה</div>
  <div class="val" id="daysSince">—</div>
</div>
      <div class="box">
        <div class="ttl">ממוצע נוכחי (לפי כלל 8 שעות שינה/יום)</div>
        <div class="val" id="avgDisplay">—</div>
      </div>
      <div class="box">
        <div class="ttl">הסיגריה האחרונה</div>
        <div class="val" id="lastSmoke">—</div>
      </div>
      <div class="box">
        <div class="ttl">מותר לעשן שוב ב</div>
        <div class="val" id="nextAllowed">—</div>
      </div>
      <div class="box">
        <div class="ttl">זמן שנותר עד ההתרה</div>
        <div class="val" id="remainAllowed">—</div>
      </div>
      <div class="box">
        <div class="ttl">כדי לחזור לממוצע היעד חכה לפחות</div>
        <div class="val" id="waitForAvg">—</div>
      </div>
      <div class="box">
  <div class="ttl">הסיגריה הראשונה היום</div>
  <div class="val" id="firstOfDay">—</div>
</div>
      <div class="box">
        <div class="ttl">שעה מומלצת לחזרה לממוצע</div>
        <div class="val" id="whenForAvg">—</div>
      </div>
    </div>
        

    <div class="footer">
      <div class="toast" id="toast">מצב: מוכן</div>
      <div class="ta" id="debug"></div>
    </div>
  </div>
  </div> 
    
  
 <script>
  const LS_KEY = 'smokeApp.v1';

const state = {
  targetMinutes: 120,
  events: [],
  carryOver: 0,
  // מעקב הפסקות (Pause):
  pause: {
    isPaused: false,
    startedAt: 0,
    totalMs: 0
  }
};

function loadFromStorage(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const data = JSON.parse(raw);
      if(Array.isArray(data.events)) state.events = data.events;
      if(Number.isFinite(data.targetMinutes)) state.targetMinutes = data.targetMinutes;
      if(Number.isFinite(data.carryOver)) state.carryOver = data.carryOver;

      if (data.pause && typeof data.pause === 'object') {
        state.pause.isPaused  = Boolean(data.pause.isPaused);
        state.pause.startedAt = Number.isFinite(data.pause.startedAt) ? data.pause.startedAt : 0;
        state.pause.totalMs   = Number.isFinite(data.pause.totalMs)   ? data.pause.totalMs   : 0;
      }
    }
  }catch(e){}
  document.getElementById('targetMinutes').value = state.targetMinutes;
}

function saveToStorage(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

function resetAll(){
  if(!confirm('לאפס נתונים?')) return;
  state.events = [];
  state.carryOver = 0;
  state.pause = { isPaused:false, startedAt:0, totalMs:0 };
  localStorage.setItem('quitStartISO', new Date().toISOString());
  saveToStorage();
  updateUI();
}

const MIN = 60000;

function fmtDur(ms){
  let m=Math.floor(ms/60000); 
  let h=Math.floor(m/60); 
  m=m%60;
  if(h>0) return h+"ש "+m+"ד"; 
  return m+"ד";
}

function updateUI(){
  const total=state.events.length;
  document.getElementById('totalCount').textContent=total;
  const sod=new Date(); sod.setHours(0,0,0,0);
  const daily=state.events.filter(ts=>ts>=sod.getTime()).length;
  document.getElementById('todayCount').textContent=daily;

  // הסיגריה הראשונה היום
  let firstToday = null;
  for (let i = 0; i < state.events.length; i++) {
    if (state.events[i] >= sod.getTime()) {
      firstToday = state.events[i];
      break;
    }
  }
  document.getElementById('firstOfDay').textContent =
    firstToday
      ? new Date(firstToday).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })
      : '—';

  // ממוצע מתגלגל עד עכשיו
  if (total >= 2) {
    const first = state.events[0];
    const now   = Date.now();

    const dayMs = 24 * 60 * 60 * 1000;
    const fullDays = Math.floor((now - first) / dayMs);

    let activeMs = (now - first) - (fullDays * 8 * 60 * 60 * 1000);
    if (activeMs < 0) activeMs = 0;

    const gaps = total - 1;
    const avgMs = activeMs / gaps;

    document.getElementById('avgDisplay').textContent = fmtDur(avgMs);

    const last = state.events[total - 1];
    document.getElementById('lastSmoke').textContent =
      new Date(last).toLocaleTimeString('he-IL', { hour:'2-digit', minute:'2-digit' });
  } else {
    document.getElementById('avgDisplay').textContent = '—';
    document.getElementById('lastSmoke').textContent = '—';
  }

  // חישוב מותר לעשן שוב + זמן שנותר עם תמיכה ב-pause
  const now = Date.now();
  if (total > 0) {
    const last = state.events[total - 1];
    const nextWait = state.targetMinutes + state.carryOver;

    const livePausedMs =
      (state.pause.isPaused && state.pause.startedAt)
        ? (now - state.pause.startedAt)
        : 0;

    const extraPauseMs = state.pause.totalMs + livePausedMs;

    const nextTs = last + (nextWait * MIN) + extraPauseMs;

    document.getElementById('nextAllowed').textContent =
      new Date(nextTs).toLocaleTimeString('he-IL', { hour:'2-digit', minute:'2-digit' });

    const remainTotal = Math.max(0, nextTs - now);
    document.getElementById('remainAllowed').textContent = fmtDur(remainTotal);
  } else {
    document.getElementById('nextAllowed').textContent = '—';
    document.getElementById('remainAllowed').textContent = '—';
  }
    // עדכון מצב כפתורים לפי state.pause
if (state.pause.isPaused) {
  document.getElementById('btnPause').classList.add('active');
  document.getElementById('btnResume').classList.remove('active');
} else {
  document.getElementById('btnPause').classList.remove('active');
  document.getElementById('btnResume').classList.add('active');
}
}

// --- כפתורים --- //
document.getElementById('btnSmoke').addEventListener('click',()=>{
  const now=Date.now();
  if(state.events.length>0){
    const last=state.events[state.events.length-1];
    const since=(now-last)/MIN;
    let deficit= state.targetMinutes - since;
    if(deficit>0){
      state.carryOver+=deficit;
    } else {
      state.carryOver=Math.max(0,state.carryOver+deficit);
    }
  }

  state.events.push(now);

  // התחלה מחודשת של מחזור – מאפסים הפסקות
  state.pause.isPaused = false;
  state.pause.startedAt = 0;
  state.pause.totalMs = 0;

  saveToStorage();
  updateUI();
});

document.getElementById('btnSave').addEventListener('click',saveToStorage);
document.getElementById('btnReset').addEventListener('click',resetAll);

document.getElementById('targetMinutes').addEventListener('change',e=>{
  state.targetMinutes=Math.max(1,Math.round(Number(e.target.value)||60));
  e.target.value=state.targetMinutes;
  saveToStorage();
  updateUI();
});

document.getElementById('btnPause').addEventListener('click', () => {
  if (state.pause.isPaused) return;
  state.pause.isPaused = true;
  state.pause.startedAt = Date.now();
  saveToStorage();
  updateUI();

  // עדכון כפתורים
  document.getElementById('btnPause').classList.add('active');
  document.getElementById('btnResume').classList.remove('active');

  const t = document.getElementById('toast');
  if (t) t.textContent = 'מצב: הטיימר בהפסקה';
});

document.getElementById('btnResume').addEventListener('click', () => {
  if (!state.pause.isPaused) return;
  const now = Date.now();
  const delta = Math.max(0, now - (state.pause.startedAt || now));
  state.pause.totalMs += delta;
  state.pause.isPaused = false;
  state.pause.startedAt = 0;
  saveToStorage();
  updateUI();

  // עדכון כפתורים
  document.getElementById('btnPause').classList.remove('active');
  document.getElementById('btnResume').classList.add('active');

  const t = document.getElementById('toast');
  if (t) t.textContent = 'מצב: הטיימר חזר לפעולה';
});

// --- אינטרוול ועדכון ראשוני --- //
setInterval(updateUI,20000);
loadFromStorage();
updateUI();

// ---- ספירת ימים מהתחלת הגמילה ----
// מפתח שמירת תאריך התחלה
const START_KEY = 'quitStartISO';

// אם אין עדיין תאריך התחלה – שומר את עכשיו
if (!localStorage.getItem(START_KEY)) {
  localStorage.setItem(START_KEY, new Date().toISOString());
}

// פונקציה שמחזירה את תאריך ההתחלה
function getStartDate() {
  return new Date(localStorage.getItem(START_KEY));
}

// מחשב כמה ימים עברו מאז ההתחלה
function getDaysPassed() {
  const start = getStartDate();
  const now = new Date();
  return Math.floor((now - start) / (24 * 60 * 60 * 1000));
}

// חישוב כמות סיגריות שמותרות היום
function getDailyQuota() {
  const START_CIGS = 20;        // כמות התחלתית
  const daysPassed = getDaysPassed();
  const cigsLeft = START_CIGS - Math.floor(daysPassed / 3); // מוריד סיגריה כל 3 ימים
  return Math.max(cigsLeft, 0); // לא יורד מתחת ל־0
}

// מציג על המסך
function renderQuota() {
  const quotaEl = document.getElementById('dailyQuota');
  if (!quotaEl) return;
  quotaEl.textContent = `מותר לך היום ${getDailyQuota()} סיגריות`;
}

// הפעלה ראשונה
renderQuota();
  
</script>
</body>
</html>
