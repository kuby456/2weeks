<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>הגרלה סודית</title>
<style>
  body {
    font-family: "Heebo", sans-serif;
    text-align: center;
    background: black;
    color: #00ffcc;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    margin: 0;
  }

  #timer {
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 30px;
    letter-spacing: 3px;
  }

  #runningName {
    font-size: 56px;
    font-weight: bold;
    color: #00ffcc;
    text-shadow: 0 0 10px #00ffcc;
    transition: all 0.2s ease;
  }

  #adminPanel {
    display: none;
    position: absolute;
    bottom: 20px;
    background: rgba(255,255,255,0.1);
    border: 1px solid #00ffcc;
    border-radius: 12px;
    padding: 15px;
    color: white;
  }

  input, button {
    font-size: 18px;
    margin: 5px;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    outline: none;
  }

  button {
    background: #00ffcc;
    color: black;
    cursor: pointer;
  }

  #secretInput {
    display: none;
    position: absolute;
    top: 20px;
  }
</style>
</head>
<body>

<div id="runningName"></div>
<br><br>
<div id="timer"></div>

<!-- ניהול מוסתר -->
<input type="password" id="secretInput" placeholder="הכנס קוד">
<div id="adminPanel">
  <input type="text" id="nameInput" placeholder="הוסף שם">
  <button id="addName">הוסף</button>
  <input type="datetime-local" id="drawTime">
  <button id="startTimer">הפעל טיימר</button>
  <button id="resetNames">אפס שמות</button>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://iqbjosvmzfgdbqnnbwvl.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxYmpvc3ZtemZnZGJxbm5id3ZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDYxNTAsImV4cCI6MjA3NjI4MjE1MH0.A6HmQXRdbIfrtNzvdlXhGHpTY7RlYahRW369oGygQUs";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_KEY = "1231";
let names = [];
let drawTime = 0;
let drawInterval;
let nameInterval;
let runningSpeed = 1000;
let clickCount = 0;
let clickTimer;

const timerDisplay = document.getElementById("timer");
const runningName = document.getElementById("runningName");
const secretInput = document.getElementById("secretInput");
const adminPanel = document.getElementById("adminPanel");
const nameInput = document.getElementById("nameInput");
const addNameBtn = document.getElementById("addName");
const startTimerBtn = document.getElementById("startTimer");
const drawTimeInput = document.getElementById("drawTime");
  const resetNamesBtn = document.getElementById("resetNames");

// --- קריאת נתונים מה-Supabase ---
async function loadFromSupabase() {
  const { data, error } = await supabase.from("lottery_data").select("*").limit(1).single();

  if (error) {
    console.error("שגיאה בטעינה:", error);
    timerDisplay.textContent = "00:00:00:00";
    runningName.textContent = "";
    return;
  }

  if (data) {
    names = data.names || [];
    drawTime = data.draw_time || 0;
    if (drawTime > Date.now()) {
      startCountdown();
      startNameRotation();
    } else {
      timerDisplay.textContent = "00:00:00:00";
    }
  }
}

// --- שמירה ב-Supabase ---
async function saveToSupabase() {
  await supabase.from("lottery_data").update({
    names,
    draw_time: drawTime,
    active: true
  }).eq("id", 1);
}

// --- מנגנון 20 לחיצות לפתיחת סוד ---
document.body.addEventListener("click", () => {
  clickCount++;
  clearTimeout(clickTimer);
  clickTimer = setTimeout(() => clickCount = 0, 1000);
  if (clickCount >= 20) {
    clickCount = 0;
    secretInput.style.display = "block";
    secretInput.focus();
  }
});

// --- פתיחת פאנל אחרי קוד ---
secretInput.addEventListener("keyup", (e) => {
  if (e.key === "Enter") {
    if (secretInput.value === ADMIN_KEY) {
      adminPanel.style.display = "block";
      secretInput.style.display = "none";
      secretInput.value = "";
    } else {
      alert("קוד שגוי");
      secretInput.value = "";
    }
  }
});

// --- הוספת שם ---
addNameBtn.onclick = async () => {
  const name = nameInput.value.trim();
  if (!name) return;
  names.push(name);
  nameInput.value = "";
  await saveToSupabase();
};
  
// --- אפס שמות ---
resetNamesBtn.onclick = async () => {
  if (!confirm("לאפס את כל השמות?")) return;

  names = [];
  runningName.textContent = "אין משתתפים"; // ✅ מציג הודעה ברורה במסך
  await supabase.from("lottery_data").update({ names: [] }).eq("id", 1);

  alert("✅ כל השמות אופסו בהצלחה!");
};
// --- התחלת טיימר ---
startTimerBtn.onclick = async () => {
  if (!drawTimeInput.value) return alert("בחר זמן");
  
  // ✅ בכל התחלה חדשה — החזרת מהירות ריצה רגילה
  runningSpeed = 1000;

  drawTime = new Date(drawTimeInput.value).getTime();
  adminPanel.style.display = "none";
  await saveToSupabase();
  startCountdown();
  startNameRotation();
};
// --- ריצה של שמות ---
function startNameRotation() {
  if (names.length === 0) {
    runningName.textContent = "אין משתתפים";
    return;
  }

  clearInterval(nameInterval);
  nameInterval = setInterval(() => {
    runningName.textContent = names[Math.floor(Math.random() * names.length)];
  }, runningSpeed);
}

// --- טיימר רץ ---
function startCountdown() {
  clearInterval(drawInterval);
  drawInterval = setInterval(() => {
    const now = new Date().getTime();
    const diff = drawTime - now;

    if (diff <= 0) {
      clearInterval(drawInterval);
      clearInterval(nameInterval);
      finishDraw();
      return;
    }

    // האצה ב-30 שניות האחרונות
    if (diff <= 30000 && runningSpeed !== 100) {
      runningSpeed = 100;
      startNameRotation(); // מפעיל מחדש את ההרצה עם מהירות חדשה
    }

    const d = Math.floor(diff / (1000*60*60*24));
    const h = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
    const m = Math.floor((diff % (1000*60*60)) / (1000*60));
    const s = Math.floor((diff % (1000*60)) / 1000);
    timerDisplay.textContent = `${d}:${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }, 1000);
}

// --- סיום ההגרלה ---
function finishDraw() {
  const win = names[Math.floor(Math.random() * names.length)];
  runningName.textContent = `🎉 ${win} 🎉`;
  runningName.style.color = "#ffcc00";
  runningName.style.textShadow = "0 0 15px #ffcc00";
  supabase.from("lottery_data").update({ active: false }).eq("id", 1);
}

// --- טעינה ראשונית ---
loadFromSupabase();
</script>

</body>
</html>
