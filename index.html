<!DOCTYPE html><html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>××¤×œ×™×§×¦×™×™×ª ×¢×™×©×•×Ÿ â€“ ×××•×¦×¢×™× ×•××¨×•×•×—×™×</title>
  <style>
    :root {
      --bg: #0b1020;        /* ×›×”×” ××œ×’× ×˜×™ */
      --card: #121734;      /* ×§×œ×£ ×›×”×” */
      --muted: #9aa3b2;     /* ×˜×§×¡×˜ ××©× ×™ */
      --text: #eaf0ff;      /* ×˜×§×¡×˜ ×¨××©×™ */
      --accent: #6ea8fe;    /* ×›×¤×ª×•×¨×™× */
      --accent-2: #70e1a1;  /* ×ª×©×•×‘×•×ª ×—×™×•×‘×™×•×ª */
      --danger: #ff7a7a;    /* ××—×™×§×” */
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width: 980px; margin: 24px auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.1fr 1fr; } }
    .card { background: var(--card); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.04);} 
    h1 { margin: 0 0 6px; font-size: 22px; }
    .muted { color: var(--muted); font-size: 13px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 0 0 auto; }
    .grow { flex:1 1 auto; }
    label { font-size: 14px; color: var(--muted); }
    input[type="number"] { background: #0e1430; border:1px solid rgba(255,255,255,.08); color:var(--text); border-radius: 12px; padding: 10px 12px; width: 120px; }
    button { cursor: pointer; border: none; border-radius: 12px; padding: 10px 14px; font-weight: 600; font-size: 14px; }
    .btn { background: var(--accent); color:#05122b; }
    .btn:active { transform: translateY(1px); }
    .btn-ghost { background: transparent; border:1px solid rgba(255,255,255,.12); color:var(--text);} 
    .btn-danger { background: var(--danger); color:#1a0b0b; }
    .kpi { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px; }
    @media (min-width: 700px){ .kpi { grid-template-columns: repeat(3,minmax(0,1fr)); } }
    .kpi .box { background:#0e1430; padding:14px; border-radius: 14px; border:1px solid rgba(255,255,255,.06); }
    .kpi .ttl { font-size:12px; color:var(--muted); margin-bottom:6px; }
    .kpi .val { font-size:20px; font-variant-numeric: tabular-nums; }
    .ok { color: var(--accent-2); }
    .warn { color: #ffd277; }
    .bad { color: var(--danger); }
    .ta { font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; color:var(--muted);}
    .footer { margin-top:6px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .toast { font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <button 
  onclick="window.location.href='index2.html'" 
  style="
    display:block;
    margin:40px auto; 
    padding:12px 24px; 
    font-size:18px; 
    border:none; 
    border-radius:10px; 
    background:#3b82f6; 
    color:#fff; 
    cursor:pointer;
  "
>
  ××¢×‘×¨ ×œ×¢××•×“ ×”×‘×
</button>
  <div class="wrap">
    <div class="grid">
      <div class="card">
        <h1>××¤×œ×™×§×¦×™×™×ª ×¢×™×©×•×Ÿ</h1>
        <div class="muted">×”×ª×¦×•×’×” ××ª×¢×“×›× ×ª ××•×˜×•××˜×™×ª ×›×œ 20 ×©× ×™×•×ª (×•×’× ××™×“ ×›×©×™×© ×©×™× ×•×™).</div><div style="height:10px"></div>
       
        
    <div class="row">
      <label for="targetMinutes">××¨×•×•×— ×™×¢×“ (×“×§×•×ª) ×‘×™×Ÿ ×¡×™×’×¨×™×•×ª:</label>
      <input id="targetMinutes" type="number" min="1" step="1" value="120" />
      <button id="btnSmoke" class="btn">×¢×™×©× ×ª×™</button>
      <button id="btnSave" class="btn-ghost">×©××•×¨ × ×ª×•× ×™×</button>
      <button id="btnReset" class="btn-danger">××™×¤×•×¡ × ×ª×•× ×™×</button>
    </div>

    <div style="height:14px"></div>

    <div class="kpi">
      <div class="box">
        <div class="ttl">××¡×¤×¨ ×¡×™×’×¨×™×•×ª ×›×•×œ×œ</div>
        <div class="val" id="totalCount">0</div>
      </div>
      <div class="box">
        <div class="ttl">××¡×¤×¨ ×¡×™×’×¨×™×•×ª ×”×™×•× (×××¤×¡ ×‘â€‘00:00)</div>
        <div class="val" id="todayCount">0</div>
      </div>
      <!-- ×”×•×¡×£ ××™×¤×” ×©× ×•×— ×œ×š ×‘×ª×•×š .kpi -->
<div class="box">
  <div class="ttl">×–××Ÿ ×××– ×”×ª×—×œ×ª ×”×’××™×œ×”</div>
  <div class="val" id="daysSince">â€”</div>
</div>
      <div class="box">
        <div class="ttl">×××•×¦×¢ × ×•×›×—×™ (×œ×¤×™ ×›×œ×œ 8 ×©×¢×•×ª ×©×™× ×”/×™×•×)</div>
        <div class="val" id="avgDisplay">â€”</div>
      </div>
      <div class="box">
        <div class="ttl">×”×¡×™×’×¨×™×” ×”××—×¨×•× ×”</div>
        <div class="val" id="lastSmoke">â€”</div>
      </div>
      <div class="box">
        <div class="ttl">××•×ª×¨ ×œ×¢×©×Ÿ ×©×•×‘ ×‘</div>
        <div class="val" id="nextAllowed">â€”</div>
      </div>
      <div class="box">
        <div class="ttl">×–××Ÿ ×©× ×•×ª×¨ ×¢×“ ×”×”×ª×¨×”</div>
        <div class="val" id="remainAllowed">â€”</div>
      </div>
      <div class="box">
        <div class="ttl">×›×“×™ ×œ×—×–×•×¨ ×œ×××•×¦×¢ ×”×™×¢×“ ×—×›×” ×œ×¤×—×•×ª</div>
        <div class="val" id="waitForAvg">â€”</div>
      </div>
      <div class="box">
        <div class="ttl">×©×¢×” ××•××œ×¦×ª ×œ×—×–×¨×” ×œ×××•×¦×¢</div>
        <div class="val" id="whenForAvg">â€”</div>
      </div>
    </div>

    <div class="footer">
      <div class="toast" id="toast">××¦×‘: ××•×›×Ÿ</div>
      <div class="ta" id="debug"></div>
    </div>
  </div>
  </div> 
    
  
 <script>
  const LS_KEY = 'smokeApp.v1';
  const state = {
    targetMinutes: 120,
    events: [],
    carryOver: 0
  };

  function loadFromStorage(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const data = JSON.parse(raw);
        if(Array.isArray(data.events)) state.events = data.events;
        if(Number.isFinite(data.targetMinutes)) state.targetMinutes = data.targetMinutes;
        if(Number.isFinite(data.carryOver)) state.carryOver = data.carryOver;
      }
    }catch(e){}
    document.getElementById('targetMinutes').value = state.targetMinutes;
  }

  function saveToStorage(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function resetAll(){
  if(!confirm('×œ××¤×¡ × ×ª×•× ×™×?')) return;
  state.events = [];
  state.carryOver = 0;
  localStorage.setItem('quitStartISO', new Date().toISOString()); // ×××¤×¡ ××ª ×ª×—×™×œ×ª ×”×’××™×œ×”
  saveToStorage();
  updateUI();
}

  const MIN=60000;

  function fmtDur(ms){
    let m=Math.floor(ms/60000); let h=Math.floor(m/60); m=m%60;
    if(h>0) return h+"×© "+m+"×“"; return m+"×“";
  }

  function updateUI(){
    const total=state.events.length;
    document.getElementById('totalCount').textContent=total;
    const sod=new Date(); sod.setHours(0,0,0,0);
    const daily=state.events.filter(ts=>ts>=sod.getTime()).length;
    document.getElementById('todayCount').textContent=daily;

    // ×××•×¦×¢ ×¤×©×•×˜ ×‘×œ×™ ×”×©×™× ×•×™ ×”××™×•×—×“
    // ×××•×¦×¢ ××¨×•×•×—×™× ×××™×ª×™: ×‘×™×Ÿ ×”×¨××©×•× ×” ×œ××—×¨×•× ×”, ×¤×—×•×ª 8 ×©×¢×•×ª ×œ×›×œ ×™×•× ××œ×, ×œ×—×œ×§ ×‘-(N-1)
// --- ×××•×¦×¢ "××ª×’×œ×’×œ" ×¢×“ ×¢×›×©×™×•, ×œ× ×¡×•×¤×¨ ××ª ×”×¨××©×•× ×” (N-1) ---
if (total >= 2) {
  const first = state.events[0];
  const now   = Date.now();

  const dayMs = 24 * 60 * 60 * 1000;
  const fullDays = Math.floor((now - first) / dayMs);

  // ×–××Ÿ ×¤×¢×™×œ: ××”×¨××©×•× ×” ×¢×“ ×¢×›×©×™×•, ×¤×—×•×ª 8 ×©×¢×•×ª ×œ×›×œ ××¢×‘×¨ ×—×¦×•×ª ××œ×
  let activeMs = (now - first) - (fullDays * 8 * 60 * 60 * 1000);
  if (activeMs < 0) activeMs = 0;

  const gaps = total - 1;        // ğŸ‘ˆ ×œ× ×¡×•×¤×¨×™× ××ª ×”×¨××©×•× ×”
  const avgMs = activeMs / gaps; // ğŸ‘ˆ ×—×œ×•×§×” ×‘-(N-1)

  document.getElementById('avgDisplay').textContent = fmtDur(avgMs);

  // "×”×¡×™×’×¨×™×” ×”××—×¨×•× ×”" ××¦×™×’×” ××ª ×–××Ÿ ×”××™×¨×•×¢ ×”××—×¨×•×Ÿ ×›×¨×’×™×œ
  const last = state.events[total - 1];
  document.getElementById('lastSmoke').textContent =
    new Date(last).toLocaleTimeString('he-IL', { hour:'2-digit', minute:'2-digit' });
} else {
  document.getElementById('avgDisplay').textContent = 'â€”';
  document.getElementById('lastSmoke').textContent = 'â€”';
}

    // ×—×™×©×•×‘ ×”××ª× ×” ×œ×¤×™ ×›×œ×œ carryOver
    const now=Date.now();
    if(total>0){
      const last=state.events[total-1];
     
      // ×× × ×©××¨ ××”×§×•×“× ×œ× ×›×•×¡×” => ××¦×˜×‘×¨ ×œ-carryOver
      const nextWait= state.targetMinutes + state.carryOver;
      document.getElementById('nextAllowed').textContent=new Date(last + nextWait*MIN).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
      const remainTotal=(last + nextWait*MIN)-now;
      document.getElementById('remainAllowed').textContent=fmtDur(remainTotal);
    }else{
      document.getElementById('nextAllowed').textContent='â€”';
      document.getElementById('remainAllowed').textContent='â€”';
    }
  }

  document.getElementById('btnSmoke').addEventListener('click',()=>{
    const now=Date.now();
    if(state.events.length>0){
      const last=state.events[state.events.length-1];
      const since=(now-last)/MIN;
      let deficit= state.targetMinutes - since;
      if(deficit>0){
        state.carryOver+=deficit; // ×ª×•×¡×™×£ ××ª ××” ×©×œ× ×›×™×¡×™× ×•
      } else {
        // ×× ×›×™×¡×™× ×• ××¢×œ ×”××™× ×™××•×, × × ×§×” ×—×œ×§ ××”×—×•×‘
        state.carryOver=Math.max(0,state.carryOver+deficit); // deficit ×©×œ×™×œ×™ ×× ×§×” ×—×•×‘
      }
    }
    state.events.push(now);
    saveToStorage();
    updateUI();
  });

  document.getElementById('btnSave').addEventListener('click',saveToStorage);
  document.getElementById('btnReset').addEventListener('click',resetAll);
  document.getElementById('targetMinutes').addEventListener('change',e=>{
    state.targetMinutes=Math.max(1,Math.round(Number(e.target.value)||60));
    e.target.value=state.targetMinutes;
    saveToStorage();
    updateUI();
  });

  setInterval(updateUI,20000);
  loadFromStorage();
  updateUI();
    // ---- ×¡×¤×™×¨×ª ×™××™× ××”×ª×—×œ×ª ×”×’××™×œ×” ----
const START_KEY = 'quitStartISO';
const daysEl = document.getElementById('daysSince');
const startLabel = document.getElementById('quitStartLabel');

// ×× ××™×Ÿ ×ª××¨×™×š ×”×ª×—×œ×” ×©××•×¨ â€“ ×©××•×¨ ×¢×›×©×™×•
if (!localStorage.getItem(START_KEY)) {
  localStorage.setItem(START_KEY, new Date().toISOString());
}

// ×¤×•× ×§×¦×™×” ×©××—×–×™×¨×” ××ª ×ª××¨×™×š ×”×”×ª×—×œ×”
function getStartDate() {
  return new Date(localStorage.getItem(START_KEY));
}

// ××¦×™×’ ×ª××¨×™×š ×”×ª×—×œ×” ×™×¤×”
function renderStartLabel() {
  if (!startLabel) return;
  const d = getStartDate();
  const dt = new Intl.DateTimeFormat('he-IL', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(d);
  startLabel.textContent = `×”×ª×—×œ×ª ×”×’××™×œ×” â€” ${dt}`;
}

// ××¦×™×’ ×›××” ×™××™×/×©×¢×•×ª/×“×§×•×ª ×¢×‘×¨×•
function renderDaysSince() {
  if (!daysEl) return;
  const now = new Date();
  const start = getStartDate();
  let diff = now - start;

  const dayMs = 24 * 60 * 60 * 1000;
  const days = Math.floor(diff / dayMs);
  const hours = Math.floor((diff % dayMs) / (60*60*1000));
  const minutes = Math.floor((diff % (60*60*1000)) / (60*1000));
  const seconds = Math.floor((diff % (60*1000)) / 1000);

  daysEl.textContent = `${days} ×™××™×, ${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

// ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
renderStartLabel();
renderDaysSince();

// ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×›×œ ×©× ×™×™×”
setInterval(renderDaysSince, 1000);
</script>
</body>
</html>
